<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 åŒ—æµ·é“å¤å­£è¦ªå­è‡ªé§•ä¹‹æ—… (Summer Road Trip)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #F0F4F8; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .boarding-pass { background: linear-gradient(135deg, #fff 0%, #f3f4f6 100%); border-left: 4px solid #3B82F6; }
        .soft-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .active-scale:active { transform: scale(0.98); }
        @keyframes loadBar { from { width: 0; } }
        .animate-bar { animation: loadBar 1s ease-out forwards; }
        .highlight-tag { background-color: #FEF3C7; color: #92400E; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 4px; }
        .transit-badge { background-color: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .sync-status { position: fixed; top: 10px; right: 10px; z-index: 50; font-size: 10px; padding: 4px 8px; border-radius: 12px; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; gap: 4px; backdrop-filter: blur(4px); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ef4444; }
        .status-dot.connected { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-md mx-auto bg-[#F5F7FA] min-h-screen relative shadow-2xl overflow-hidden sm:max-w-full md:max-w-[480px]">
        
        <div class="sync-status">
            <div :class="['status-dot', isConnected ? 'connected' : '']"></div>
            <span>{{ isConnected ? 'å·²åŒæ­¥' : 'é€£ç·šä¸­...' }}</span>
        </div>

        <header class="relative w-full h-[250px] z-10">
            <div class="absolute inset-0 w-full h-full overflow-hidden rounded-b-[3rem] shadow-lg">
                <img :src="bannerImage" alt="Hokkaido Summer" class="w-full h-full object-cover brightness-90">
                <div class="absolute inset-0 bg-gradient-to-t from-blue-900/60 to-transparent"></div>
            </div>
            
            <div class="absolute top-6 left-6 text-white drop-shadow-md">
                <h1 class="text-2xl font-bold tracking-widest">HOKKAIDO 2026</h1>
                <p class="text-sm opacity-90">Summer Road Trip</p>
            </div>

            <div class="absolute bottom-4 right-6 flex gap-3 z-20">
                <button @click="currentTab = 'itinerary'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'itinerary' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']"><i class="fa-solid fa-location-dot"></i></button>
                <button @click="currentTab = 'info'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'info' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']"><i class="fa-solid fa-circle-info"></i></button>
                <button @click="currentTab = 'shopping'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'shopping' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']"><i class="fa-solid fa-basket-shopping"></i></button>
                <button @click="currentTab = 'expenses'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'expenses' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']"><i class="fa-solid fa-yen-sign"></i></button>
            </div>
        </header>

        <main class="relative z-0 -mt-8 pt-10 pb-24 px-4 min-h-[calc(100vh-250px)]">
            
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index" :class="['flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all cursor-pointer border active-scale', currentDayIndex === index ? 'bg-blue-600 text-white border-blue-600 shadow-lg shadow-blue-200' : 'bg-white text-gray-400 border-transparent']">
                        <span class="text-xs font-bold uppercase">{{ day.weekday }}</span><span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-lg mb-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <i :class="[tripDays[currentDayIndex].weather.icon, 'text-blue-500 text-xl']"></i>
                            <div><span class="text-sm font-bold text-slate-700">{{ tripDays[currentDayIndex].location }}</span><span class="text-xs text-gray-400 ml-2">{{ tripDays[currentDayIndex].weather.desc }} {{ tripDays[currentDayIndex].weather.temp }}Â°C</span></div>
                        </div>
                    </div>
                    <div class="flex items-start gap-2"><div class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded shrink-0">ğŸ’ ä»Šæ—¥å¿…å¸¶</div><div class="text-xs text-slate-600 leading-relaxed font-medium">{{ tripDays[currentDayIndex].mustBring }}</div></div>
                </div>
                <div class="space-y-4">
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group">
                        <div v-if="item.transit" @click="openRoute(index)" class="flex items-center justify-center py-2 text-xs text-blue-400 hover:text-blue-600 gap-2 cursor-pointer transition-colors active:scale-95"><span class="h-6 w-[1px] bg-blue-200"></span><div class="transit-badge shadow-sm"><i :class="getTransitIcon(item.transit.type)"></i><span class="font-bold">{{ item.transit.duration || 'æŸ¥çœ‹è·¯ç·š' }}</span><i class="fa-solid fa-chevron-right text-[8px] opacity-50 ml-1"></i></div><span class="h-6 w-[1px] bg-blue-200"></span></div>
                        <div @click="openActionModal(item)" :class="['relative z-10 bg-white p-4 border border-slate-100 rounded-2xl soft-shadow transition-transform duration-300 ease-out pr-12 cursor-pointer active:scale-[0.99]', item.type === 'flight' ? 'boarding-pass' : '']">
                            <div class="absolute right-0 top-0 bottom-0 flex flex-col justify-center items-center gap-2 px-2 bg-gray-50/50 border-l border-gray-100 rounded-r-2xl" @click.stop><button v-if="index > 0" @click="moveItem(index, -1)" class="w-8 h-8 text-gray-400 hover:text-blue-500 active:text-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-up"></i></button><button v-if="index < currentDayItinerary.length - 1" @click="moveItem(index, 1)" class="w-8 h-8 text-gray-400 hover:text-blue-500 active:text-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-down"></i></button></div>
                            <div v-if="item.type === 'flight'" class="flex flex-col gap-3 mb-2 mr-4"><div class="flex justify-between items-center border-b border-dashed border-slate-300 pb-2"><div class="text-2xl font-black text-blue-800">{{ item.flightInfo.depCode }}</div><i class="fa-solid fa-plane text-blue-400"></i><div class="text-2xl font-black text-blue-800">{{ item.flightInfo.arrCode }}</div></div><div class="flex justify-between text-sm"><div><div class="text-xs text-gray-500">èµ·é£›</div><div class="font-bold">{{ item.time }}</div></div><div class="text-right"><div class="text-xs text-gray-500">èˆªç­</div><div class="font-bold">{{ item.flightInfo.number }}</div></div></div><div class="bg-blue-50 text-blue-600 text-xs p-2 rounded mt-1"><i class="fa-solid fa-circle-info mr-1"></i> {{ item.note }}</div></div>
                            <div v-else class="flex gap-4 mb-2 mr-2"><div class="flex flex-col items-center min-w-[3rem]"><span class="text-sm font-bold text-slate-700">{{ item.time.split(' ')[0] }}</span><div :class="['w-8 h-8 rounded-full flex items-center justify-center text-white mt-1 text-xs', getCategoryColor(item.category)]"><i :class="getCategoryIcon(item.category)"></i></div></div><div class="flex-1"><h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">{{ item.name }}</h3><div v-if="item.tags" class="flex flex-wrap gap-1 mb-1"><span v-for="tag in item.tags" class="highlight-tag">{{ tag }}</span></div><div v-if="item.businessHours" class="text-xs text-gray-500 mb-1"><i class="fa-regular fa-clock mr-1"></i> {{ item.businessHours }}</div><div v-if="item.ticket" class="text-xs text-orange-500 mb-1 font-medium"><i class="fa-solid fa-ticket mr-1"></i> {{ item.ticket }}</div></div></div>
                            <div class="flex border-t border-gray-100 mt-2 pt-2 gap-2"><button @click.stop="openMap(item.name)" class="flex-1 flex items-center justify-center gap-1 py-2 text-sm text-blue-600 font-bold bg-blue-50 rounded-xl active:scale-95 transition-transform"><i class="fa-solid fa-location-dot"></i> å°èˆª</button><button @click.stop="openDetail(item)" class="flex-1 flex items-center justify-center gap-1 py-2 text-sm text-orange-600 font-bold bg-orange-50 rounded-xl active:scale-95 transition-transform"><i class="fa-solid fa-book-open"></i> æ”»ç•¥</button></div>
                        </div>
                    </div>
                </div>
                <div class="h-20 flex items-center justify-center text-xs text-gray-400"><i class="fa-solid fa-hand-pointer mr-1"></i> é»æ“Šè¡Œç¨‹å¡ç‰‡å¯ç·¨è¼¯æˆ–åˆªé™¤</div>
                <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-30"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div v-if="currentTab === 'info'" class="space-y-6 animate-fade-in pb-20"><section class="bg-white rounded-2xl p-5 soft-shadow"><h3 class="font-bold text-blue-900 mb-4 flex items-center justify-between"><span><i class="fa-solid fa-suitcase-rolling mr-2"></i> è¡Œææ‰“åŒ…æ¸…å–®</span><button @click="resetPackingList" class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">é‡ç½®é è¨­</button></h3><div class="space-y-5"><div v-for="(category, catIndex) in packingList" :key="catIndex"><h4 class="text-sm font-bold text-slate-500 mb-2 pl-1 border-l-4 border-blue-200">{{ category.name }}</h4><div class="grid grid-cols-1 gap-2"><div v-for="(item, itemIndex) in category.items" :key="itemIndex" class="flex items-center gap-2 p-2 bg-gray-50 rounded-xl active:bg-gray-100"><label class="flex items-center gap-2 flex-1 cursor-pointer select-none"><input type="checkbox" v-model="item.checked" @change="savePackingList" class="hidden custom-checkbox"><div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center bg-white transition-colors shrink-0"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><span :class="['text-sm transition-all', item.checked ? 'text-gray-400 line-through' : 'text-slate-700']">{{ item.name }}</span></label><button @click="removePackingItem(catIndex, itemIndex)" class="text-gray-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash-can text-sm"></i></button></div><div class="flex gap-2 mt-1"><input v-model="newPackingInputs[catIndex]" @keyup.enter="addPackingItem(catIndex)" class="flex-1 bg-white border border-dashed border-gray-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:border-blue-300" placeholder="æ–°å¢é …ç›®..."><button @click="addPackingItem(catIndex)" class="bg-blue-50 text-blue-500 px-3 rounded-lg text-sm hover:bg-blue-100"><i class="fa-solid fa-plus"></i></button></div></div></div></div></section><section class="bg-white rounded-2xl p-5 soft-shadow"><h3 class="font-bold text-blue-900 mb-4 flex items-center"><i class="fa-solid fa-coins mr-2"></i> åŒ¯ç‡æ›ç®—</h3><div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex-1"><label class="text-xs text-gray-500 block mb-1">æ—¥å¹£ (JPY)</label><input type="number" v-model="calcJpy" class="w-full bg-transparent text-xl font-bold outline-none" placeholder="0"></div><i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i><div class="flex-1 text-right"><label class="text-xs text-gray-500 block mb-1">å°å¹£ (TWD)</label><div class="text-xl font-bold text-blue-600">{{ calculatedTwd }}</div></div></div><p class="text-xs text-gray-400 mt-2 text-right">åŒ¯ç‡è¨­å®š: {{ exchangeRate }}</p></section><section><h3 class="font-bold text-slate-700 mb-3 ml-1">ä½å®¿è³‡è¨Š</h3><div class="space-y-3"><div v-for="hotel in hotelInfos" :key="hotel.name" class="bg-white rounded-2xl p-4 soft-shadow"><h4 class="font-bold text-blue-900">{{ hotel.name }}</h4><p class="text-xs text-gray-500 mt-1 mb-2">{{ hotel.engName }}</p><div class="flex flex-col gap-2 text-sm text-gray-600"><div class="flex items-start gap-2"><i class="fa-solid fa-map-pin mt-1 text-red-400"></i><a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(hotel.address)" target="_blank" class="underline decoration-gray-300">{{ hotel.address }}</a></div><div class="flex items-center gap-2"><i class="fa-solid fa-user text-blue-400"></i><span>{{ hotel.booker }} ({{ hotel.platform }})</span></div></div></div></div></section></div>

            <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20"><div class="grid grid-cols-2 gap-4"><div v-for="(item, idx) in shoppingList" :key="idx" @click="editShoppingItem(item, idx)" class="bg-white rounded-2xl p-3 soft-shadow flex flex-col relative group active:scale-95 transition-transform cursor-pointer"><div class="aspect-square bg-gray-100 rounded-xl mb-2 overflow-hidden flex items-center justify-center relative"><img v-if="item.image" :src="item.image" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-300 text-2xl"></i><div class="absolute bottom-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"><i class="fa-solid fa-pen"></i></div></div><h4 class="font-bold text-sm text-slate-700 truncate">{{ item.name }}</h4></div><div @click="openShoppingModal" class="bg-white/50 border-2 border-dashed border-blue-200 rounded-2xl flex flex-col items-center justify-center aspect-square cursor-pointer text-blue-300 hover:bg-blue-50 active-scale"><i class="fa-solid fa-plus text-3xl mb-2"></i><span class="text-xs font-bold">æ–°å¢å•†å“</span></div></div></div>
            
            <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20 relative"><div class="flex justify-end mb-4"><button @click="showStatsModal = true" class="bg-white text-blue-600 border border-blue-100 px-4 py-2 rounded-xl text-sm font-bold shadow-sm active-scale flex items-center gap-2"><i class="fa-solid fa-chart-pie text-blue-500"></i> çµ±è¨ˆå ±è¡¨</button></div><div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-xl mb-6"><div class="text-sm opacity-60 mb-1">ç¸½èŠ±è²» (JPY)</div><div class="text-4xl font-bold mb-4">Â¥ {{ totalExpenses.toLocaleString() }}</div><div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4"><div><div class="text-xs opacity-60">ç¾é‡‘æ”¯ä»˜</div><div class="font-bold text-lg">Â¥ {{ cashTotal.toLocaleString() }}</div></div><div><div class="text-xs opacity-60">ä¿¡ç”¨å¡æ”¯ä»˜</div><div class="font-bold text-lg">Â¥ {{ cardTotal.toLocaleString() }}</div></div></div></div><div class="bg-white rounded-2xl soft-shadow overflow-hidden"><div v-for="(exp, idx) in expenses" :key="exp.id" @click="editExpense(exp)" class="p-4 border-b border-gray-50 flex justify-between items-center last:border-0 active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0', getExpenseColor(exp.category)]"><i :class="getExpenseIcon(exp.category)"></i></div><div><div class="font-bold text-slate-700">{{ exp.name }}</div><div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div></div></div><div class="text-right"><div class="font-bold text-slate-800">Â¥{{ exp.amount.toLocaleString() }}</div><div class="text-xs text-gray-400"><span v-if="exp.method === 'ç¾é‡‘'" class="text-green-500 font-bold">ç¾é‡‘</span><span v-else class="text-blue-500 font-bold"><i class="fa-regular fa-credit-card mr-1"></i>{{ exp.customName || exp.method }}</span></div></div></div><div v-if="expenses.length === 0" class="p-8 text-center text-gray-400 text-sm">é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„ï¼ŒæŒ‰å³ä¸‹è§’æ–°å¢ï¼</div></div><button @click="openExpenseModal" class="fixed bottom-24 right-6 w-14 h-14 bg-emerald-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-30"><i class="fa-solid fa-plus"></i></button></div>
        </main>

        <div v-if="showActionModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.self="showActionModal = false"><div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all scale-100 text-center animate-slide-up"><h3 class="text-lg font-bold mb-1 text-slate-800">è¡Œç¨‹ç®¡ç†</h3><p class="text-sm text-gray-500 mb-6 truncate">{{ selectedActionItem.name }}</p><div class="space-y-3"><button @click="triggerEdit" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 transition-colors"><i class="fa-solid fa-pen"></i> ä¿®æ”¹è¡Œç¨‹</button><button @click="triggerDelete" class="w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition-colors"><i class="fa-solid fa-trash-can"></i> åˆªé™¤è¡Œç¨‹</button><button @click="showActionModal = false" class="w-full text-gray-400 py-2 text-sm">å–æ¶ˆ</button></div></div></div>
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="closeModal"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]"><h3 class="text-xl font-bold mb-4 text-center shrink-0">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><div class="space-y-4 overflow-y-auto no-scrollbar flex-1 pb-4"><div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-gray-500 ml-1">é¡åˆ¥</label><select v-model="modalForm.category" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100"><option value="sight">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shop">è³¼ç‰©</option><option value="hotel">ä½å®¿</option><option value="traffic">äº¤é€š</option><option value="other">å…¶ä»–</option></select></div><div><label class="text-xs text-gray-500 ml-1">æ™‚é–“</label><input type="time" v-model="modalForm.startTime" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100"></div></div><div><label class="text-xs text-gray-500 ml-1">åç¨±</label><input v-model="modalForm.name" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100" placeholder="è¡Œç¨‹åç¨±"></div><div><label class="text-xs text-gray-500 ml-1">å€‹äººå‚™è¨»</label><textarea v-model="modalForm.note" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100" rows="3" placeholder="å¯«ä¸‹ä½ çš„ç­†è¨˜..."></textarea></div></div><div class="flex gap-3 mt-auto pt-2 shrink-0"><button @click="saveItem" class="w-full flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:bg-blue-700">å„²å­˜</button></div></div></div>
        <div v-if="showDetailModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/60 backdrop-blur-sm" @click.self="showDetailModal = false"><div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up max-h-[85vh] overflow-y-auto relative"><div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div><div class="text-center mb-6"><div :class="['inline-flex items-center justify-center w-16 h-16 rounded-full text-white text-2xl mb-3 shadow-lg', getCategoryColor(selectedDetailItem.category)]"><i :class="getCategoryIcon(selectedDetailItem.category)"></i></div><h3 class="text-2xl font-bold text-slate-800">{{ selectedDetailItem.name }}</h3><div class="text-sm text-gray-500 mt-1">{{ selectedDetailItem.time }} Â· {{ selectedDetailItem.businessHours || 'æ™‚é–“ä¾ç¾å ´ç‚ºä¸»' }}</div></div><div class="space-y-4"><div class="bg-blue-50 p-4 rounded-2xl border border-blue-100"><h4 class="font-bold text-blue-800 mb-2 flex items-center"><i class="fa-solid fa-circle-info mr-2"></i> å°éŠä»‹ç´¹</h4><p class="text-sm text-slate-700 leading-relaxed whitespace-pre-line">{{ selectedDetailItem.desc || 'æš«ç„¡ä»‹ç´¹' }}</p></div><div v-if="selectedDetailItem.mustEat" class="bg-orange-50 p-4 rounded-2xl border border-orange-100"><h4 class="font-bold text-orange-800 mb-2 flex items-center"><i class="fa-solid fa-utensils mr-2"></i> å¿…åƒ / å¿…é€›</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.mustEat }}</p></div><div v-if="selectedDetailItem.mustBuy" class="bg-purple-50 p-4 rounded-2xl border border-purple-100"><h4 class="font-bold text-purple-800 mb-2 flex items-center"><i class="fa-solid fa-bag-shopping mr-2"></i> å¿…è²·ä¼´æ‰‹ç¦®</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.mustBuy }}</p></div><div v-if="selectedDetailItem.photoTip" class="bg-pink-50 p-4 rounded-2xl border border-pink-100"><h4 class="font-bold text-pink-800 mb-2 flex items-center"><i class="fa-solid fa-camera mr-2"></i> æ‹ç…§æŠ€å·§</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.photoTip }}</p></div><div v-if="selectedDetailItem.note" class="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 class="font-bold text-gray-700 mb-2">æ‚¨çš„å‚™è¨»</h4><p class="text-sm text-gray-600">{{ selectedDetailItem.note }}</p></div></div><button @click="showDetailModal = false" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold mt-6 text-lg shadow-lg active:scale-95 transition-transform">é—œé–‰æ”»ç•¥</button></div></div>
        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showShoppingModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">{{ isEditingShopping ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' }}</h3><input v-model="shoppingForm.name" class="w-full bg-gray-50 p-3 rounded-xl mb-4" placeholder="å•†å“åç¨±"><div class="mb-4"><label class="block w-full aspect-video bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center cursor-pointer hover:border-blue-400"><span v-if="!shoppingForm.image" class="text-gray-400"><i class="fa-solid fa-camera mr-2"></i>{{ isEditingShopping ? 'æ›´æ›ç…§ç‰‡' : 'ä¸Šå‚³ç…§ç‰‡' }}</span><img v-else :src="shoppingForm.image" class="h-full object-contain"><input type="file" class="hidden" @change="handleImageUpload"></label></div><div class="flex gap-3"><button v-if="isEditingShopping" @click="deleteShoppingItem" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">åˆªé™¤</button><button @click="addShoppingItem" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">å„²å­˜</button></div></div></div>
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showExpenseModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">{{ isEditingExpense ? 'ç·¨è¼¯èŠ±è²»' : 'æ–°å¢èŠ±è²»' }}</h3><div class="space-y-3"><select v-model="expenseForm.category" class="w-full bg-gray-50 p-3 rounded-xl"><option value="é£²é£Ÿ">é£²é£Ÿ</option><option value="äº¤é€š">äº¤é€š</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="é–€ç¥¨">é–€ç¥¨</option><option value="ä½å®¿">ä½å®¿</option><option value="å…¶ä»–">å…¶ä»–</option></select><input v-model="expenseForm.name" class="w-full bg-gray-50 p-3 rounded-xl" placeholder="é …ç›®åç¨±"><input type="number" v-model="expenseForm.amount" class="w-full bg-gray-50 p-3 rounded-xl" placeholder="é‡‘é¡ (JPY)"><div class="bg-gray-50 p-3 rounded-xl border border-gray-100 space-y-2"><label class="text-xs text-gray-500 block">ä»˜æ¬¾æ–¹å¼</label><select v-model="expenseForm.paymentType" class="w-full bg-white p-2 rounded-lg border border-gray-200"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option></select><div v-if="expenseForm.paymentType === 'ä¿¡ç”¨å¡'"><input v-model="expenseForm.customName" list="used-cards-list" class="w-full bg-white p-2 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="è¼¸å…¥æˆ–é¸æ“‡å¡ç‰‡ (å¦‚: åœ‹æ³°CUBE)"><datalist id="used-cards-list"><option v-for="card in usedCards" :value="card"></option></datalist></div></div></div><div class="flex gap-3 mt-4"><button v-if="isEditingExpense" @click="deleteExpense" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold active:bg-red-200">åˆªé™¤</button><button @click="saveExpense" class="flex-1 bg-emerald-500 text-white py-3 rounded-xl font-bold active:bg-emerald-600">å„²å­˜</button></div></div></div>
        <div v-if="showStatsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.self="showStatsModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[80vh] overflow-y-auto no-scrollbar"><h3 class="text-xl font-bold mb-6 text-center text-slate-800">ğŸ“Š æ¶ˆè²»çµ±è¨ˆè¡¨</h3><div class="mb-8"><h4 class="text-sm font-bold text-gray-500 mb-3 ml-1">æ”¯ä»˜æ–¹å¼å æ¯”</h4><div class="space-y-4"><div v-for="(amount, method) in cardBreakdown" :key="method" class="bg-gray-50 rounded-xl p-3 border border-gray-100"><div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700 flex items-center gap-2"><i v-if="method==='ç¾é‡‘'" class="fa-solid fa-money-bill-1 text-green-500"></i><i v-else class="fa-regular fa-credit-card text-blue-500"></i>{{ method }}</span><span class="font-bold">Â¥ {{ amount.toLocaleString() }}</span></div><div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="bg-blue-500 h-2 rounded-full animate-bar" :style="{ width: (totalExpenses > 0 ? (amount / totalExpenses * 100) : 0) + '%' }"></div></div><div class="text-right text-xs text-gray-400 mt-1">{{ totalExpenses > 0 ? Math.round(amount / totalExpenses * 100) : 0 }}%</div></div></div></div><div><h4 class="text-sm font-bold text-gray-500 mb-3 ml-1">æ¶ˆè²»é¡åˆ¥åˆ†æ</h4><div class="space-y-3"><div v-for="(amount, cat) in categoryBreakdown" :key="cat" class="flex items-center gap-3"><div :class="['w-8 h-8 rounded-full flex items-center justify-center text-white text-xs shrink-0', getExpenseColor(cat)]"><i :class="getExpenseIcon(cat)"></i></div><div class="flex-1"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-slate-700">{{ cat }}</span><span>Â¥ {{ amount.toLocaleString() }}</span></div><div class="w-full bg-gray-100 rounded-full h-1.5"><div :class="['h-1.5 rounded-full animate-bar', getExpenseColor(cat)]" :style="{ width: (totalExpenses > 0 ? (amount / totalExpenses * 100) : 0) + '%' }"></div></div></div></div></div></div><button @click="showStatsModal = false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-8 shadow-lg">é—œé–‰å ±è¡¨</button></div></div>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref as dbRef, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ğŸŸ¢ æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyA8sysOQedr-G4itsrWzW-i6BfRCLKT_3Q",
          authDomain: "osaka2026-c5974.firebaseapp.com",
          databaseURL: "https://osaka2026-c5974-default-rtdb.firebaseio.com",
          projectId: "osaka2026-c5974",
          storageBucket: "osaka2026-c5974.firebasestorage.app",
          messagingSenderId: "576795484651",
          appId: "1:576795484651:web:72e880993d168436d8b9ae"
        };

        // åˆå§‹åŒ– Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        createApp({
            setup() {
                // ğŸŸ¢ 1. ä¿®æ”¹ï¼šè³‡æ–™åº«è·¯å¾‘æ”¹ç‚º Sapporo_2026
                const DB_PATH = 'Sapporo_2026'; 

                const isConnected = ref(false);
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showModal = ref(false);
                const showDetailModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showStatsModal = ref(false);
                const showActionModal = ref(false);
                const selectedActionItem = ref({});
                const isEditing = ref(false);
                const isEditingExpense = ref(false);
                const isEditingShopping = ref(false); 
                const editingShoppingIndex = ref(null); 
                const bannerImage = ref('banner.jpg');
                const selectedDetailItem = ref({});

                const exchangeRate = ref(0.22); // åŒ¯ç‡å¯ä¾ç•¶æ™‚ç‹€æ³èª¿æ•´
                const calcJpy = ref('');
                const calculatedTwd = computed(() => {
                    return calcJpy.value ? Math.round(calcJpy.value * exchangeRate.value).toLocaleString() : '0';
                });

                const defaultPackingList = [
                    { name: 'é‡è¦è­‰ä»¶èˆ‡éŒ¢åŒ…', items: [{ name: 'è­·ç…§', checked: false }, { name: 'é§•ç…§ + æ—¥æ–‡è­¯æœ¬ (è‡ªé§•å¿…å‚™)', checked: false }, { name: 'æ—¥å¹£ç¾é‡‘/ä¿¡ç”¨å¡', checked: false }, { name: 'VJW æˆªåœ–', checked: false }] },
                    { name: 'è¡£ç‰©èˆ‡ä¿æš–', items: [{ name: 'è–„å¤–å¥— (æ—©æ™šæº«å·®)', checked: false }, { name: 'å¥½èµ°çš„é‹', checked: false }, { name: 'å¸½å­/å¢¨é¡ (é˜²æ›¬)', checked: false }, { name: 'æ›æ´—è¡£ç‰©', checked: false }] },
                    { name: '3C èˆ‡è—¥å“', items: [{ name: 'æ‰‹æ©Ÿ/å……é›»ç·š/è»Šå……', checked: false }, { name: 'è¡Œå‹•é›»æº', checked: false }, { name: 'é˜²èšŠæ¶² (é‡è¦)', checked: false }, { name: 'å¸¸å‚™è—¥/OKç¹ƒ', checked: false }] }
                ];
                const packingList = ref(JSON.parse(JSON.stringify(defaultPackingList)));
                const newPackingInputs = ref({}); 

                // ğŸŸ¢ 2. ä¿®æ”¹ï¼šæ›´æ–°è¡Œç¨‹æ—¥æœŸèˆ‡å¤©æ°£ (7/19 - 7/26)
                const tripDays = ref([
                    { date: '7/19', weekday: 'Sun', fullDate: '2026-07-19', location: 'æœ­å¹Œå¸‚å€', weather: { temp: 24, feels: 22, icon: 'fa-solid fa-cloud-sun', desc: 'èˆ’é©' }, mustBring: 'è­·ç…§ã€é§•ç…§æ—¥æ–‡è­¯æœ¬(é‡è¦)ã€éš¨èº«è–„å¤–å¥—ã€‚' },
                    { date: '7/20', weekday: 'Mon', fullDate: '2026-07-20', location: 'æœ­å¹Œå¸‚å€', weather: { temp: 26, feels: 25, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }, mustBring: 'å¥½èµ°çš„é‹ (å…¬åœ’æ•£æ­¥)ã€ç›¸æ©Ÿã€‚' },
                    { date: '7/21', weekday: 'Tue', fullDate: '2026-07-21', location: 'å¯Œè‰¯é‡', weather: { temp: 28, feels: 30, icon: 'fa-solid fa-sun', desc: 'è‰·é™½' }, mustBring: 'é˜²æ›¬ä¹³ã€å¢¨é¡ã€é˜²èšŠæ¶²ã€è»Šç”¨å……é›»å™¨ã€‚' },
                    { date: '7/22', weekday: 'Wed', fullDate: '2026-07-22', location: 'æ—­å·/ç¾ç‘›', weather: { temp: 25, feels: 24, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²' }, mustBring: 'æ°´å£º (å‹•ç‰©åœ’å¾ˆç†±)ã€å¥½æ´»å‹•çš„è¡£æœã€‚' },
                    { date: '7/23', weekday: 'Thu', fullDate: '2026-07-23', location: 'å°æ¨½', weather: { temp: 23, feels: 20, icon: 'fa-solid fa-wind', desc: 'æµ·é¢¨' }, mustBring: 'è–„å¤–å¥— (æµ·é‚Šé¢¨å¤§)ã€é›¶éŒ¢ (è²·ä¼´æ‰‹ç¦®)ã€‚' },
                    { date: '7/24', weekday: 'Fri', fullDate: '2026-07-24', location: 'æœ­å¹Œ', weather: { temp: 25, feels: 25, icon: 'fa-solid fa-shop', desc: 'å®¤å…§' }, mustBring: 'å¤§è³¼ç‰©è¢‹ã€ä¿¡ç”¨å¡ã€‚' },
                    { date: '7/25', weekday: 'Sat', fullDate: '2026-07-25', location: 'åŒ—å»£å³¶', weather: { temp: 26, feels: 26, icon: 'fa-solid fa-sun', desc: 'æ™´æ™‚å¤šé›²' }, mustBring: 'é˜²æ›¬ã€å°å­©çš„æ”¾é›»ç²¾ç¥ã€‚' },
                    { date: '7/26', weekday: 'Sun', fullDate: '2026-07-26', location: 'æ–°åƒæ­²', weather: { temp: 24, feels: 24, icon: 'fa-solid fa-plane', desc: 'è¿”å®¶' }, mustBring: 'è­·ç…§ã€æ²’èŠ±å®Œçš„æ—¥å¹£ã€‚' },
                ]);

                // ğŸŸ¢ 3. ä¿®æ”¹ï¼šæ›´æ–°ç‚ºåŒ—æµ·é“è©³ç´°è¡Œç¨‹
                const defaultItinerary = {
                    0: [ // Day 1: 7/19
                        { id: 1, type: 'flight', category: 'flight', name: 'æ˜Ÿå®‡ JX850 (æš«å®š)', time: '15:00', flightInfo: { depCode: 'TPE', arrCode: 'CTS', number: 'JX850' }, note: 'æ©Ÿä¸Šå¡« VJW', desc: 'å°æœ‹å‹è«‹åœ¨é£›æ©Ÿä¸Šç¡é£½ï¼ŒåŒ—æµ·é“æˆ‘å€‘ä¾†äº†ï¼ä¸‹é£›æ©Ÿå¾Œæ°£æº«æœƒæœ‰é»æ¶¼ï¼Œå»ºè­°éš¨èº«æ”œå¸¶è–„å¤–å¥—ã€‚', transit: null },
                        { id: 2, type: 'normal', category: 'traffic', name: 'JR å¿«é€Ÿ Airport', time: '16:30', note: 'å¾€æœ­å¹Œç«™', desc: 'å‰å¾€æœ­å¹Œç«™ (å¾åœ‹å…§ç·šèˆªå»ˆ B1 æ­è»Š)ã€‚é€™ç­è»Šäººé€šå¸¸å¾ˆå¤šï¼Œå¦‚æœæ²’ä½å­ï¼ŒåæŒ‡å®šå¸­ (U-Seat) é›–ç„¶è¦åŠ éŒ¢ä½†æœ‰ä½å­æœƒæ¯”è¼ƒèˆ’æœ (ç´„37åˆ†é˜)ã€‚', transit: { type: 'train', duration: '37åˆ†' } },
                        { id: 3, type: 'normal', category: 'hotel', name: 'Check-in: Vessel Inn', time: '17:30', note: 'ä¸­å³¶å…¬åœ’', desc: 'ã€Vessel Inn Nakajima Parkã€‘é€™å®¶çš„æ—©é¤æ˜¯å…¨æ—¥æœ¬æ’åå‰å¹¾åçš„ï¼æœ‰è‘—åçš„æµ·é®®ä¸¼åƒåˆ°é£½ï¼', transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 4, type: 'normal', category: 'food', name: 'æ ¹å®¤èŠ±ä¸¸è¿´è½‰å£½å¸', time: '18:30', note: 'Stellar Place 6F', 
                          desc: 'é€™æ˜¯åŒ—æµ·é“æœ€æœ‰åçš„æ’éšŠååº—ï¼åœ¨æœ­å¹Œè»Šç«™ä¸Šé¢ã€‚', 
                          mustEat: 'å¹²è²ã€é®­é­šåµè»è‰¦ã€èŠ±å’²èŸ¹éµç ²æ±ã€‚', 
                          transit: { type: 'walk', duration: '15åˆ†' } }
                    ],
                    1: [ // Day 2: 7/20
                        { id: 10, type: 'normal', category: 'sight', name: 'ç™½è‰²æˆ€äººå…¬åœ’', time: '09:30', note: 'åœ°éµæ±è¥¿ç·š', 
                          desc: 'é€™è£¡æ˜¯åšé¤…ä¹¾çš„åŸå ¡ï¼å¯ä»¥çœ‹åˆ°é¤…ä¹¾æ€éº¼åšå‡ºä¾†çš„ï¼Œé‚„å¯ä»¥é«”é©—è‡ªå·±ç•«é¤…ä¹¾ã€‚', 
                          mustEat: 'ç™½è‰²æˆ€äººéœœæ·‡æ·‹ (Mixå£å‘³)ã€‚', 
                          photoTip: 'ä¸­åº­çš„èŠ±åœ’å’Œæ­å¼åŸå ¡èƒŒæ™¯å¿…æ‹ã€‚',
                          transit: { type: 'train', duration: '20åˆ†' } },
                        { id: 11, type: 'normal', category: 'food', name: 'æ¹¯å’–å“© Suage+', time: '12:30', note: 'è–„é‡ç«™', 
                          desc: 'é€™æ˜¯åŒ—æµ·é“ç‰¹æœ‰çš„å’–å“©ï¼Œåƒæ¹¯ä¸€æ¨£å¯ä»¥ç›´æ¥å–ï¼Œä¸æœƒå¾ˆè¾£ï¼Œå°æœ‹å‹ä¹Ÿèƒ½æ¥å—ã€‚', 
                          mustEat: 'çŸ¥åºŠé›é‡èœæ¹¯å’–å“©ã€åŠ é»èµ·å¸é£¯ã€‚', 
                          transit: { type: 'train', duration: '15åˆ†' } },
                        { id: 12, type: 'normal', category: 'sight', name: 'å¤§é€šå…¬åœ’ & é›»è¦–å¡”', time: '15:00', note: 'æ•£æ­¥', 
                          desc: 'å¤å¤©çš„å¤§é€šå…¬åœ’é€šå¸¸æœ‰ã€Œå•¤é…’ç¯€ã€å’Œè‘—åçš„ã€Œçƒ¤ç‰ç±³æ”¤è²©ã€ã€‚', 
                          mustEat: 'å¤§é€šå…¬åœ’çƒ¤ç‰ç±³ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 13, type: 'normal', category: 'shop', name: 'ç‹¸å°è·¯å•†åº—è¡—', time: '16:30', note: 'è—¥å¦æ¡è²·', 
                          desc: 'è¶é‚„æ²’ç§Ÿè»Šï¼Œå…ˆä¾†é€›è¡—ã€‚ç‹¸å°è·¯æœ‰å¾ˆå¤šå¤¾å¨ƒå¨ƒæ©Ÿåº—ã€‚', 
                          mustBuy: 'è–¯æ¢ä¸‰å…„å¼Ÿã€åŒ—æµ·é“é™å®šé¢è†œã€‚', 
                          transit: { type: 'walk', duration: '5åˆ†' } }
                    ],
                    2: [ // Day 3: 7/21 (è‡ªé§•é–‹å§‹)
                        { id: 20, type: 'normal', category: 'traffic', name: 'ã€è‡ªé§•é–‹å§‹ã€‘å–è»Š', time: '09:00', note: 'æª¢æŸ¥ ETC å¡', desc: 'é‡è¦ï¼ç¢ºèªæœ‰ç§Ÿå€Ÿ ETC å¡ï¼Œéæ”¶è²»ç«™æ‰æ–¹ä¾¿ã€‚å°èˆªç›®æ¨™ï¼šå¯Œç”°è¾²å ´ (MapCode: 349 276 801)ã€‚', transit: { type: 'car', duration: '2å°æ™‚' } },
                        { id: 21, type: 'normal', category: 'sight', name: 'å¯Œç”°è¾²å ´ (è–°è¡£è‰)', time: '11:30', note: 'èŠ±æœŸå¤§çˆ†ç™¼', 
                          desc: 'ã€Œå“‡ï¼ç´«è‰²çš„åœ°æ¯¯ï¼ã€é€™è£¡æ˜¯åŒ—æµ·é“æœ€æœ‰åçš„è–°è¡£è‰ç”°ï¼Œ7æœˆä¸­ä¸‹æ—¬å‰›å¥½æ˜¯æ»¿é–‹æœŸã€‚', 
                          mustEat: 'è–°è¡£è‰å†°æ·‡æ·‹ã€å“ˆå¯†ç“œåˆ‡ç‰‡ã€‚', 
                          photoTip: 'ç´«è‰²çš„èŠ±æµ·é…ä¸ŠèƒŒæ™¯çš„å±±è„ˆã€‚',
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 22, type: 'normal', category: 'food', name: 'Popura Farm', time: '14:00', note: 'å“ˆå¯†ç“œåƒåˆ°é£½', 
                          desc: 'å¯Œè‰¯é‡çš„å“ˆå¯†ç“œè¶…ç´šç”œï¼æ¨è–¦å»åƒã€Œè–èª•è€äººçš„é¬å­ã€(å“ˆå¯†ç“œåŠ éœœæ·‡æ·‹)ã€‚', 
                          mustEat: 'è–èª•è€äººçš„é¬å­ã€‚', 
                          transit: { type: 'car', duration: '15åˆ†' } },
                        { id: 23, type: 'normal', category: 'sight', name: 'æ£®æ—ç²¾éˆéœ²å°', time: '16:30', note: 'æ–°å¯Œè‰¯é‡ç‹å­é£¯åº—', 
                          desc: 'ã€Œæ£®æ—è£¡æœ‰å°ç²¾éˆä½çš„å°æœ¨å±‹ï¼ã€å‚æ™šé»ç‡ˆå¾Œæ°£æ°›è¶…ç´šå¤¢å¹»ã€‚', 
                          transit: { type: 'car', duration: '20åˆ†' } },
                        { id: 24, type: 'normal', category: 'hotel', name: 'Check-in: å¯Œè‰¯é‡', time: '18:00', note: 'Naturwald', 
                          desc: 'Hotel Naturwald Furano (å¯Œè‰¯é‡è‡ªç„¶æ£®æ—é£¯åº—)ï¼Œéå¸¸é©åˆè¦ªå­å…¥ä½ã€‚', 
                          transit: { type: 'car', duration: '5åˆ†' } }
                    ],
                    3: [ // Day 4: 7/22
                        { id: 30, type: 'normal', category: 'sight', name: 'ç™½é‡‘é’æ± ', time: '09:00', note: 'å¤¢å¹»è—è‰²', 
                          desc: 'ã€Œæ°´çœŸçš„æ˜¯è—è‰²çš„è€¶ï¼å¥½åƒåŠ äº†é¡æ–™ä¸€æ¨£ï¼ã€å¤¢å¹»çš„è—è‰²æ± å¡˜ã€‚', 
                          transit: { type: 'car', duration: '30åˆ†' } },
                        { id: 31, type: 'normal', category: 'sight', name: 'ç¾ç‘›æ‹¼å¸ƒä¹‹è·¯', time: '10:30', note: 'Ken & Mary ä¹‹æ¨¹', 
                          desc: 'é–‹è»Šå…œé¢¨æ™‚é–“ï¼è·¯é‚Šçš„ç”°ä¸€å¡Šç¶ ä¸€å¡Šé»ƒï¼Œçœ‹èµ·ä¾†å°±åƒæ‹¼å¸ƒä¸€æ¨£æ¼‚äº®ã€‚', 
                          transit: { type: 'car', duration: '20åˆ†' } },
                        { id: 32, type: 'normal', category: 'sight', name: 'æ—­å±±å‹•ç‰©åœ’', time: '13:00', note: 'ä¼éµ/åŒ—æ¥µç†Š', 
                          desc: 'ã€å…¨æ—¥æœ¬æœ€æ£’çš„å‹•ç‰©åœ’ã€‘\næµ·è±¹é¤¨ï¼šæµ·è±¹æœƒå‚ç›´æ¸¸éåœ“æŸ±ã€‚\nåŒ—æ¥µç†Šé¤¨ï¼šå¯ä»¥çœ‹åˆ°åŒ—æ¥µç†Šè·³æ°´ã€‚\nä¼éµé¤¨ï¼šé›–ç„¶å¤å¤©æ²’æœ‰æ•£æ­¥ï¼Œä½†å¯ä»¥çœ‹åˆ°ä¼éµåœ¨é ­ä¸Šçš„éš§é“æ¸¸æ³³ï¼', 
                          mustEat: 'åœ’å€å…§çš„å‹•ç‰©é€ å‹é¤…ä¹¾ã€‚', 
                          transit: { type: 'car', duration: '40åˆ†' } },
                        { id: 33, type: 'normal', category: 'hotel', name: 'Check-in: OMO7 æ—­å·', time: '17:00', note: 'æ˜Ÿé‡é›†åœ˜', 
                          desc: 'å¤§å»³éå¸¸æœ‰è¶£ï¼Œæœ‰è‘—åçš„ã€Œæ—­å·æ‹‰éºµåœ°åœ–ã€å¯ä»¥åƒè€ƒã€‚', 
                          transit: { type: 'car', duration: '30åˆ†' } },
                        { id: 34, type: 'normal', category: 'food', name: 'æ—­å·æ‹‰éºµæ‘', time: '18:30', note: 'é¸æ“‡éšœç¤™', 
                          desc: 'é€™è£¡é›†åˆäº†æ—­å·æœ€æœ‰åçš„ 8 å®¶æ‹‰éºµåº—ï¼Œå¯ä»¥ä»»é¸ä¸€å®¶ã€‚', 
                          transit: { type: 'car', duration: '15åˆ†' } }
                    ],
                    4: [ // Day 5: 7/23
                        { id: 40, type: 'normal', category: 'traffic', name: 'å‰å¾€å°æ¨½', time: '09:00', note: 'é•·é€”ç§»å‹•', desc: 'èµ°é«˜é€Ÿå…¬è·¯ï¼Œä»Šå¤©è¦æŠŠè»Šé–‹å›æœ­å¹Œï¼Œä¸­é–“å…ˆå»å°æ¨½ç©ã€‚', transit: { type: 'car', duration: '2å°æ™‚' } },
                        { id: 41, type: 'normal', category: 'sight', name: 'å°æ¨½æ°´æ—é¤¨', time: '11:00', note: 'æµ·é‚Šè¡¨æ¼”', 
                          desc: 'é€™è£¡çš„æµ·ç…è¡¨æ¼”æ˜¯åœ¨çœŸæ­£çš„æµ·è£¡è·³æ°´å–”ï¼éå¸¸ç‰¹åˆ¥ã€‚', 
                          transit: { type: 'car', duration: '10åˆ†' } },
                        { id: 42, type: 'normal', category: 'food', name: 'ä¸‰è§’å¸‚å ´ æµ·é®®ä¸¼', time: '13:30', note: 'ç€§æ³¢é£Ÿå ‚', 
                          desc: 'å»åƒè¶…å¤§ç¢—çš„æµ·é®®ä¸¼ï¼ã€Œç€§æ³¢é£Ÿå ‚ã€æˆ–ã€Œæ­¦ç”°é®®é­šåº—ã€éƒ½å¾ˆç´…ã€‚', 
                          transit: { type: 'car', duration: '15åˆ†' } },
                        { id: 43, type: 'normal', category: 'shop', name: 'å°æ¨½é‹æ²³ & å ºç”ºé€š', time: '15:00', note: 'åŒ—è“æ¨“/å…­èŠ±äº­', 
                          desc: 'ã€æ³¨æ„ã€‘æœ‰å¹¾å®¶åº—å¯ä»¥è©¦åƒå·§å…‹åŠ›ï¼Œä¸è¦å®¢æ°£ï¼', 
                          mustBuy: 'åŒ—è“æ¨“æ³¡èŠ™ (å¤¢ä¸æ€è­°æ³¡èŠ™)ã€å…­èŠ±äº­ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 44, type: 'normal', category: 'traffic', name: 'è¿”å›æœ­å¹Œé‚„è»Š', time: '17:30', note: 'è¨˜å¾—åŠ æ²¹', desc: 'é–‹å›æœ­å¹Œå¸‚å€é‚„è»Šã€‚è¨˜å¾—é‚„è»Šå‰è¦æ‰¾åŠ æ²¹ç«™æŠŠæ²¹åŠ æ»¿ã€‚', transit: { type: 'car', duration: '45åˆ†' } },
                        { id: 45, type: 'normal', category: 'hotel', name: 'Check-in: æœ­å¹Œ', time: '19:00', note: 'Vessel Inn', desc: 'å›åˆ°ç†Ÿæ‚‰çš„æœ­å¹Œé£¯åº— (çºŒä½)ã€‚', transit: { type: 'walk', duration: '10åˆ†' } }
                    ],
                    5: [ // Day 6: 7/24
                        { id: 50, type: 'normal', category: 'sight', name: 'åŒ—æµ·é“å¤§å­¸', time: '09:30', note: 'æœ€ç¾æ ¡åœ’', 
                          desc: 'æ—¥æœ¬æœ€ç¾æ ¡åœ’ä¹‹ä¸€ã€‚æ ¡åœ’å¾ˆå¤§ï¼Œæœ‰å°æºªæµå¯ä»¥ç©æ°´ï¼Œé‚„æœ‰åšç‰©é¤¨ (å…è²») å¯ä»¥çœ‹æé¾åŒ–çŸ³ã€‚', 
                          transit: { type: 'train', duration: '10åˆ†' } },
                        { id: 51, type: 'normal', category: 'shop', name: 'æœ­å¹Œè»Šç«™ / ESTA', time: '14:00', note: 'Big Camera', 
                          desc: 'ESTA æ‹‰éºµå…±å’Œåœ‹ä¹Ÿåœ¨é€™è£¡ï¼Œå¦‚æœä¸é¤“å¯ä»¥å»åœ°ä¸‹è¡—åƒç”œé»ã€‚', 
                          mustBuy: 'é›»é‹ã€å¹é¢¨æ©Ÿã€Uniqlo ç™¼ç†±è¡£/ç¾½çµ¨è¡£ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 52, type: 'normal', category: 'food', name: 'æˆå‰æ€æ±—çƒ¤è‚‰', time: '18:00', note: 'é”æ‘©/éº’éºŸ', 
                          desc: 'ã€Œé€™æ˜¯ç¾Šè‚‰ï¼Œä½†æ˜¯å®Œå…¨æ²’æœ‰ç¾Šé¨·å‘³ï¼ã€æˆå‰æ€æ±—çƒ¤è‚‰æ˜¯ç”¨åƒå¸½å­å½¢ç‹€çš„éµç›¤çƒ¤çš„ï¼Œéå¸¸æœ‰ç‰¹è‰²ã€‚', 
                          mustEat: 'æˆå‰æ€æ±—ç¾Šè‚‰ã€åŒ—æµ·é“ç”Ÿå•¤é…’ã€‚', 
                          transit: { type: 'walk', duration: '15åˆ†' } }
                    ],
                    6: [ // Day 7: 7/25
                        { id: 60, type: 'normal', category: 'sight', name: 'F Village (æ£’çƒå ´)', time: '10:00', note: 'ES CON Field', 
                          desc: 'ã€2023æ–°é–‹å¹•ã€‘ç«è…¿éšŠä¸»å ´ã€‚é€™ä¸åªæ˜¯æ£’çƒå ´ï¼Œæ˜¯è¶…å¤§çš„éŠæ¨‚åœ’ï¼æœ‰å…’ç«¥éŠæˆ²å€ (Lipovitan Kids PLAYLOT) å’Œæˆ¶å¤–æ»‘ç´¢ã€‚', 
                          mustEat: 'çƒå ´é™å®šç†±ç‹—å ¡ã€‚', 
                          transit: { type: 'train', duration: '20åˆ†' } },
                        { id: 61, type: 'normal', category: 'shop', name: 'ä¸‰äº• Outlet Park', time: '15:00', note: 'åŒ—å»£å³¶', 
                          desc: 'é€™è£¡æœ‰éå¸¸å¤§çš„ Montbell (æˆ¶å¤–ç”¨å“åº—)ï¼Œé©åˆè£œè²¨ã€‚', 
                          transit: { type: 'car', duration: '20åˆ†' } },
                        { id: 62, type: 'normal', category: 'food', name: 'æœ€å¾Œçš„æ™šé¤', time: '19:00', note: 'èƒèŸ¹å°‡è»?', 
                          desc: 'çœ‹è¦ä¸è¦å¥¢ä¾ˆä¸€ä¸‹åƒã€ŒèƒèŸ¹å°‡è»ã€å¤§é¤ï¼Œæˆ–æ˜¯å†å»åƒä¸€æ¬¡æ¹¯å’–å“©å›å‘³ï¼', 
                          transit: { type: 'train', duration: '30åˆ†' } }
                    ],
                    7: [ // Day 8: 7/26
                        { id: 70, type: 'normal', category: 'traffic', name: 'å‰å¾€æ–°åƒæ­²æ©Ÿå ´', time: '10:00', note: 'ææ—©å‡ºç™¼', desc: 'æ–°åƒæ­²æ©Ÿå ´ã€Œè¶…ç´šå¥½é€›ã€ï¼Œä¸€å®šè¦ææ—© 3-4 å°æ™‚åˆ°ï¼', transit: { type: 'train', duration: '40åˆ†' } },
                        { id: 71, type: 'normal', category: 'sight', name: 'å“†å•¦Aå¤¢ç©ºä¸­æ¨‚åœ’', time: '11:00', note: 'åœ‹å…§ç·š 3F', 
                          desc: 'ã€Œæ©Ÿå ´è£¡é¢æœ‰å“†å•¦Aå¤¢ï¼ã€é‚„æœ‰ Royce å·§å…‹åŠ›å·¥å» å¯ä»¥åƒè§€ã€‚', 
                          mustEat: 'å’–å•¡å»³è—è‰²çš„å“†å•¦Aå¤¢å’–å“©é£¯ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 72, type: 'flight', category: 'flight', name: 'æ˜Ÿå®‡ JX851', time: '16:15', flightInfo: { depCode: 'CTS', arrCode: 'TPE', number: 'JX851' }, note: 'Check-in', 
                          desc: 'å…ç¨…åº—é‚„å¯ä»¥è²·å…­èŠ±äº­å’Œç™½è‰²æˆ€äººã€‚', 
                          mustBuy: 'LeTAO èµ·å¸è›‹ç³• (è¨˜å¾—è¦åŠ è³¼ä¿å†·è¢‹)ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } }
                    ]
                };

                const itineraryData = ref(JSON.parse(JSON.stringify(defaultItinerary))); 

                // ğŸŸ¢ 4. ä¿®æ”¹ï¼šèˆªç­è³‡è¨Š
                const flightInfos = [
                    { type: 'å»ç¨‹', date: '2026/7/19', dep: 'TPE', arr: 'CTS', depTime: '15:00', arrTime: '20:00', duration: '4h00m', code: 'JX850', terminal: 'æ¡ƒæ©Ÿ / æ–°åƒæ­²' },
                    { type: 'å›ç¨‹', date: '2026/7/26', dep: 'CTS', arr: 'TPE', depTime: '16:15', arrTime: '19:30', duration: '4h15m', code: 'JX851', terminal: 'æ–°åƒæ­² / æ¡ƒæ©Ÿ' }
                ];
                
                // ğŸŸ¢ 5. ä¿®æ”¹ï¼šä½å®¿è³‡è¨Š
                const hotelInfos = [
                    { name: 'Vessel Inn Nakajima Park', engName: 'Sapporo', address: 'åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å—ä¹æ¢è¥¿4-1-2', booker: 'Lai You Wen', platform: 'Agoda' },
                    { name: 'Hotel Naturwald Furano', engName: 'Furano', address: 'åŒ—æµ·é“å¯Œè‰¯é‡å¸‚åŒ—ä¹‹å³°ç”º14-46', booker: 'Lai You Wen', platform: 'Booking' },
                    { name: 'OMO7 Asahikawa', engName: 'by Hoshino Resorts', address: 'åŒ—æµ·é“æ—­å·å¸‚6æ¡é€š9ä¸ç›®', booker: 'Lai You Wen', platform: 'å®˜ç¶²' }
                ];

                const modalForm = ref({});
                const shoppingList = ref([]);
                const shoppingForm = ref({ name: '', image: null });
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: '' });

                const currentDayItinerary = computed(() => itineraryData.value[currentDayIndex.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const cashTotal = computed(() => expenses.value.filter(i => i.method === 'ç¾é‡‘' || i.paymentType === 'ç¾é‡‘').reduce((sum, item) => sum + item.amount, 0));
                const cardTotal = computed(() => expenses.value.filter(i => (i.method !== 'ç¾é‡‘' && i.paymentType !== 'ç¾é‡‘')).reduce((sum, item) => sum + item.amount, 0));
                
                const cardBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => {
                        let key = item.method;
                        if (item.paymentType) { if (item.paymentType === 'ç¾é‡‘') key = 'ç¾é‡‘'; else key = item.customName || 'ä¿¡ç”¨å¡'; }
                        breakdown[key] = (breakdown[key] || 0) + item.amount;
                    });
                    return breakdown;
                });
                
                const usedCards = computed(() => {
                    const cards = new Set();
                    expenses.value.forEach(item => {
                        if(item.paymentType === 'ä¿¡ç”¨å¡' && item.customName) cards.add(item.customName);
                        if(item.method !== 'ç¾é‡‘' && item.method !== 'ä¿¡ç”¨å¡' && item.method) cards.add(item.method);
                    });
                    return Array.from(cards);
                });
                
                const categoryBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => { breakdown[item.category] = (breakdown[item.category] || 0) + item.amount; });
                    return breakdown;
                });

                const getCategoryIcon = (cat) => { const map = { sight: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', hotel: 'fa-bed', traffic: 'fa-train-subway', flight: 'fa-plane', other: 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getCategoryColor = (cat) => { const map = { sight: 'bg-orange-400', food: 'bg-red-400', shop: 'bg-purple-400', hotel: 'bg-blue-400', traffic: 'bg-gray-400', flight: 'bg-sky-500', other: 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };
                const getTransitIcon = (type) => { if(type === 'walk') return 'fa-solid fa-person-walking'; if(type === 'car') return 'fa-solid fa-car'; if(type === 'hotel') return 'fa-solid fa-bed'; return 'fa-solid fa-train-subway'; };
                const getExpenseIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train', 'è³¼ç‰©': 'fa-bag-shopping', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getExpenseColor = (cat) => { const map = { 'é£²é£Ÿ': 'bg-red-400', 'äº¤é€š': 'bg-gray-400', 'è³¼ç‰©': 'bg-purple-400', 'é–€ç¥¨': 'bg-orange-400', 'ä½å®¿': 'bg-blue-400', 'å…¶ä»–': 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };

                const cleanName = (name) => {
                    return name.replace(/Check-in:\s*/i, '').replace(/^å‰å¾€/, '').replace(/ã€.*?ã€‘/g, '').replace(/ï¼ˆ.*?ï¼‰/g, '').trim();
                };

                const openMap = (keyword) => {
                    const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(cleanName(keyword));
                    window.open(url, '_blank');
                };

                const openRoute = (index) => {
                    const list = currentDayItinerary.value;
                    const destination = cleanName(list[index].name);
                    let origin = '';
                    let mode = 'transit'; 
                    const type = list[index].transit?.type || 'train';
                    if (type === 'car') mode = 'driving'; else if (type === 'walk') mode = 'walking';
                    
                    if (index > 0) { 
                        const prevItem = list[index - 1]; 
                        if (prevItem.type === 'flight') origin = 'New Chitose Airport'; 
                        else origin = cleanName(prevItem.name); 
                    } else { 
                        // æ›´æ–°ç‚ºåŒ—æµ·é“é£¯åº—
                        const hotels = ['New Chitose Airport', 'Vessel Inn Nakajima Park', 'Vessel Inn Nakajima Park', 'Hotel Naturwald Furano', 'OMO7 Asahikawa', 'Vessel Inn Nakajima Park', 'Vessel Inn Nakajima Park', 'Vessel Inn Nakajima Park']; 
                        origin = hotels[currentDayIndex.value] || 'Current Location'; 
                    }
                    const url = `https://www.google.com/maps/dir/?api=1&origin=$${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                    window.open(url, '_blank');
                };

                const openDetail = (item) => { selectedDetailItem.value = item; showDetailModal.value = true; };
                
                const openAddModal = () => { isEditing.value = false; modalForm.value = { category: 'sight', transitType: 'walk', startTime: '10:00', name: '', note: '', businessHours: '', ticket: '' }; showModal.value = true; };
                
                const closeModal = () => { showModal.value = false; };
                const openActionModal = (item) => { selectedActionItem.value = item; showActionModal.value = true; };
                const triggerEdit = () => { showActionModal.value = false; editItem(selectedActionItem.value); };
                const triggerDelete = () => { showActionModal.value = false; confirmDeleteItem(selectedActionItem.value); };
                const editItem = (item) => { isEditing.value = true; modalForm.value = JSON.parse(JSON.stringify(item)); modalForm.value.startTime = item.time; modalForm.value.transitType = item.transit ? item.transit.type : 'train'; showModal.value = true; };
                const confirmDeleteItem = (item) => { if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) { const dayList = itineraryData.value[currentDayIndex.value]; const idx = dayList.findIndex(i => i.id === item.id); if(idx !== -1) dayList.splice(idx, 1); saveToStorage(); } };

                const saveItem = () => { 
                    const dayList = itineraryData.value[currentDayIndex.value] || [];
                    if (!itineraryData.value[currentDayIndex.value]) itineraryData.value[currentDayIndex.value] = [];
                    
                    const newItem = { 
                        id: isEditing.value ? modalForm.value.id : Date.now(), 
                        type: modalForm.value.category === 'flight' ? 'flight' : 'normal', 
                        category: modalForm.value.category, 
                        name: modalForm.value.name || 'æœªå‘½åè¡Œç¨‹', 
                        time: modalForm.value.startTime || '00:00',
                        businessHours: modalForm.value.businessHours || '', 
                        ticket: modalForm.value.ticket || '', 
                        note: modalForm.value.note || '', 
                        tags: dayList.find(i => i.id === modalForm.value.id)?.tags || [],
                        desc: dayList.find(i => i.id === modalForm.value.id)?.desc || '',
                        mustEat: dayList.find(i => i.id === modalForm.value.id)?.mustEat || '',
                        mustBuy: dayList.find(i => i.id === modalForm.value.id)?.mustBuy || '',
                        photoTip: dayList.find(i => i.id === modalForm.value.id)?.photoTip || '',
                        transit: isEditing.value && dayList.find(i => i.id === modalForm.value.id)?.transit ? { ...dayList.find(i => i.id === modalForm.value.id).transit, type: modalForm.value.transitType } : (currentDayIndex.value === 0 && dayList.length === 0 ? null : { type: modalForm.value.transitType }), 
                        flightInfo: modalForm.value.category === 'flight' ? { depCode: 'XXX', arrCode: 'XXX', number: 'FLIGHT' } : null 
                    }; 
                    
                    if (isEditing.value) { const idx = dayList.findIndex(i => i.id === newItem.id); dayList[idx] = newItem; } else { dayList.push(newItem); } 
                    dayList.sort((a, b) => a.time.localeCompare(b.time)); 
                    saveToStorage(); 
                    showModal.value = false; 
                };
                
                const deleteItem = () => { confirmDeleteItem(modalForm.value); showModal.value = false; };
                const moveItem = (index, direction) => { const list = itineraryData.value[currentDayIndex.value]; const targetIndex = index + direction; if (targetIndex >= 0 && targetIndex < list.length) { [list[index], list[targetIndex]] = [list[targetIndex], list[index]]; saveToStorage(); } };
                
                const openShoppingModal = () => { isEditingShopping.value = false; shoppingForm.value = { name: '', image: null }; showShoppingModal.value = true; };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; editingShoppingIndex.value = idx; shoppingForm.value = { ...item }; showShoppingModal.value = true; };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.image = e.target.result; reader.readAsDataURL(file); } };
                const addShoppingItem = () => { if(shoppingForm.value.name) { if(isEditingShopping.value) { shoppingList.value[editingShoppingIndex.value] = { ...shoppingForm.value }; } else { shoppingList.value.push({ ...shoppingForm.value }); } saveToStorage(); showShoppingModal.value = false; } };
                const removeShoppingItem = (idx) => { if(confirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(idx, 1); saveToStorage(); } };
                const deleteShoppingItem = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(editingShoppingIndex.value, 1); saveToStorage(); showShoppingModal.value = false; } };

                const savePackingList = () => { saveToStorage(); };
                const resetPackingList = () => { if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ¸…å–®å—ï¼Ÿ')) { packingList.value = JSON.parse(JSON.stringify(defaultPackingList)); savePackingList(); } };
                const addPackingItem = (catIndex) => { const text = newPackingInputs.value[catIndex]; if(text && text.trim() !== '') { packingList.value[catIndex].items.push({ name: text, checked: false }); newPackingInputs.value[catIndex] = ''; savePackingList(); } };
                const removePackingItem = (catIndex, itemIndex) => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) { packingList.value[catIndex].items.splice(itemIndex, 1); savePackingList(); } };

                const openExpenseModal = () => { isEditingExpense.value = false; expenseForm.value = { id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: tripDays.value[currentDayIndex.value].fullDate }; showExpenseModal.value = true; };
                const editExpense = (exp) => { isEditingExpense.value = true; expenseForm.value = JSON.parse(JSON.stringify(exp)); if (!expenseForm.value.paymentType) { if (expenseForm.value.method === 'ç¾é‡‘') { expenseForm.value.paymentType = 'ç¾é‡‘'; } else { expenseForm.value.paymentType = 'ä¿¡ç”¨å¡'; expenseForm.value.customName = expenseForm.value.method; } } showExpenseModal.value = true; };
                const saveExpense = () => { if(expenseForm.value.name && expenseForm.value.amount) { const newExpense = { ...expenseForm.value, amount: parseInt(expenseForm.value.amount), id: isEditingExpense.value ? expenseForm.value.id : Date.now(), method: expenseForm.value.paymentType === 'ç¾é‡‘' ? 'ç¾é‡‘' : (expenseForm.value.customName || 'ä¿¡ç”¨å¡') }; if(isEditingExpense.value) { const idx = expenses.value.findIndex(e => e.id === newExpense.id); if(idx !== -1) expenses.value[idx] = newExpense; } else { expenses.value.push(newExpense); } saveToStorage(); showExpenseModal.value = false; } };
                const deleteExpense = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—ï¼Ÿ')) { const idx = expenses.value.findIndex(e => e.id === expenseForm.value.id); if(idx !== -1) expenses.value.splice(idx, 1); saveToStorage(); showExpenseModal.value = false; } };

                const saveToStorage = () => {
                    if (!db) return;
                    set(dbRef(db, DB_PATH), {
                        itinerary: itineraryData.value,
                        shopping: shoppingList.value,
                        expenses: expenses.value,
                        packing: packingList.value
                    }).catch((error) => {
                        console.error("Firebase write failed:", error);
                    });
                };

                onMounted(() => {
                    if (!db) return;
                    const tripRef = dbRef(db, DB_PATH);
                    
                    onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const data = snapshot.val();
                        if (data) {
                            if(data.itinerary) itineraryData.value = data.itinerary;
                            if(data.shopping) shoppingList.value = data.shopping;
                            if(data.expenses) expenses.value = data.expenses;
                            if(data.packing) packingList.value = data.packing;
                        } else {
                            // ğŸ’¡ è³‡æ–™åº«è‹¥ç‚ºç©ºï¼Œè‡ªå‹•å¯«å…¥æ–°çš„åŒ—æµ·é“é è¨­è¡Œç¨‹
                            saveToStorage();
                        }
                    }, (error) => {
                        isConnected.value = false;
                        console.error("Read failed:", error);
                    });
                });

                return {
                    isConnected,
                    currentTab, currentDayIndex, tripDays, currentDayItinerary, bannerImage, flightInfos, hotelInfos,
                    showModal, modalForm, openAddModal, closeModal, editItem, saveItem, deleteItem, moveItem, confirmDeleteItem,
                    openMap, openRoute, openDetail, showDetailModal, selectedDetailItem,
                    openActionModal, showActionModal, selectedActionItem, triggerEdit, triggerDelete, 
                    getCategoryIcon, getCategoryColor, getTransitIcon, exchangeRate, calcJpy, calculatedTwd,
                    shoppingList, showShoppingModal, openShoppingModal, shoppingForm, handleImageUpload, addShoppingItem, removeShoppingItem, editShoppingItem, deleteShoppingItem, isEditingShopping,
                    expenses, totalExpenses, cashTotal, cardTotal, cardBreakdown, categoryBreakdown, showExpenseModal, openExpenseModal, 
                    expenseForm, saveExpense, editExpense, deleteExpense, isEditingExpense, getExpenseIcon, getExpenseColor, showStatsModal, usedCards,
                    packingList, savePackingList, resetPackingList, addPackingItem, removePackingItem, newPackingInputs
                };
            }
        }).mount('#app');
    </script>
</body>
</html>